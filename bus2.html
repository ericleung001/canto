<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巴士到站時間查詢（九巴 & 城巴）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #loading {
            display: none;
            font-size: 18px;
            color: red;
        }
        .bus-info {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h2>巴士到站時間查詢（九巴 & 城巴）</h2>
    <label for="companySelect">選擇巴士公司：</label>
    <select id="companySelect">
        <option value="KMB">九巴</option>
        <option value="CTB">城巴</option>
    </select>
    <br><br>
    <label for="routeInput">巴士路線：</label>
    <input type="text" id="routeInput" placeholder="例如 234X">
    <button onclick="searchBus()">查詢</button>
    <div id="loading">🚍 查詢中...</div>
    <div id="result"></div>

    <script>
        const API_BASE = "https://rt.data.gov.hk/v1/transport/citybus/";
        const KMB_ROUTE_STOP_API = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop";
        const KMB_STOP_API = "https://data.etabus.gov.hk/v1/transport/kmb/stop";
        const KMB_ETA_API = "https://data.etabus.gov.hk/v1/transport/kmb/eta";
        const CTB_ETA_API = API_BASE + "eta/";

        async function fetchData(url) {
            try {
                let response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP 錯誤: ${response.status}`);
                let data = await response.json();
                return data;
            } catch (error) {
                console.error("API請求錯誤:", error);
                return null;
            }
        }

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("瀏覽器不支援定位功能"));
                    return;
                }
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }

        async function searchBus() {
            let route = document.getElementById("routeInput").value.trim().toUpperCase();
            let company = document.getElementById("companySelect").value;

            if (!route) {
                alert("請輸入巴士路線");
                return;
            }

            document.getElementById("loading").style.display = "block";
            document.getElementById("result").innerHTML = "";

            try {
                let userLocation = await getUserLocation();

                if (company === "KMB") {
                    let [routeStops, stopData] = await Promise.all([
                        fetchData(`${KMB_ROUTE_STOP_API}/${route}/inbound/1`),
                        fetchData(KMB_STOP_API)
                    ]);

                    if (!routeStops || !stopData) throw new Error("無法獲取站點資料");

                    let nearestStop = findNearestStop(userLocation, routeStops, stopData);

                    if (!nearestStop) {
                        document.getElementById("result").innerHTML = "未能找到最近的九巴站點。";
                        return;
                    }

                    let etaData = await fetchData(`${KMB_ETA_API}/KMB/${route}/${nearestStop.stop}`);
                    displayETA(nearestStop, etaData);
                } else if (company === "CTB") {
                    let etaData = await fetchData(`${CTB_ETA_API}${route}`);

                    if (!etaData || !etaData.data.length) {
                        document.getElementById("result").innerHTML = "未能獲取城巴即時到站資訊。";
                        return;
                    }

                    displayCTBETA(etaData);
                }
            } catch (error) {
                document.getElementById("result").innerHTML = "查詢失敗：" + error.message;
                console.error(error);
            } finally {
                document.getElementById("loading").style.display = "none";
            }
        }

        function findNearestStop(userLocation, routeStops, stopData) {
            let userLat = userLocation.coords.latitude;
            let userLng = userLocation.coords.longitude;
            let minDistance = Infinity;
            let nearestStop = null;

            routeStops.data.forEach(stop => {
                let stopInfo = stopData.data.find(s => s.stop === stop.stop);
                if (!stopInfo) return;

                let distance = getDistance(userLat, userLng, stopInfo.lat, stopInfo.long);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStop = stopInfo;
                }
            });

            return nearestStop;
        }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // 地球半徑 (km)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLng = (lng2 - lng1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * 
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function displayETA(stopInfo, etaData) {
            if (!etaData || !etaData.data.length) {
                document.getElementById("result").innerHTML = `站點：${stopInfo.name_tc} - 無即時到站資訊。`;
                return;
            }

            let resultHTML = `<h3>最近站點：${stopInfo.name_tc}</h3>`;
            resultHTML += `<p>到站時間：</p><ul>`;
            
            etaData.data.forEach(bus => {
                let arrivalTime = new Date(bus.eta);
                resultHTML += `<li>${arrivalTime.toLocaleTimeString()} (${bus.eta_seq} 號車）</li>`;
            });

            resultHTML += `</ul>`;
            document.getElementById("result").innerHTML = resultHTML;
        }

        function displayCTBETA(etaData) {
            let resultHTML = `<h3>城巴 ${etaData.data[0].route} 到站資訊</h3><ul>`;

            etaData.data.forEach(bus => {
                let arrivalTime = new Date(bus.eta);
                resultHTML += `<li>${bus.dest_tc} - ${arrivalTime.toLocaleTimeString()}</li>`;
            });

            resultHTML += `</ul>`;
            document.getElementById("result").innerHTML = resultHTML;
        }
    </script>
</body>
</html>
