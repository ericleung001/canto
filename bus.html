<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>巴士最近站點與到站時間</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
        }
        h1 {
            font-size: 5vw;
            margin-bottom: 20px;
        }
        #location {
            font-size: 4vw;
            margin-bottom: 10px;
        }
        #routes {
            max-height: 40vh;
            overflow-y: auto;
            margin: 10px 0;
        }
        .route-item {
            padding: 10px;
            font-size: 4vw;
            background-color: #fff;
            border: 1px solid #ddd;
            margin: 5px 0;
            cursor: pointer;
        }
        .route-item:hover {
            background-color: #e0e0e0;
        }
        #result {
            margin-top: 20px;
            font-size: 4vw;
            line-height: 1.5;
            word-wrap: break-word;
        }
        @media (max-width: 600px) {
            h1 { font-size: 6vw; }
            #location, .route-item, #result { font-size: 5vw; }
        }
    </style>
</head>
<body onload="init()">
    <h1>附近巴士路線與到站時間v2</h1>
    <div id="location">正在獲取定位...</div>
    <div id="routes"></div>
    <div id="result"></div>

    <script>
        const CITYBUS_STOP_API = 'https://rt.data.gov.hk/v2/transport/citybus/stop';
        const CITYBUS_ETA_API = 'https://rt.data.gov.hk/v2/transport/citybus/eta/ctb';
        const KMB_STOP_API = 'https://data.etabus.gov.hk/v1/transport/kmb/stop';
        const KMB_STOP_ETA_API = 'https://data.etabus.gov.hk/v1/transport/kmb/stop-eta/';
        const MTR_BUS_API = 'https://rt.data.gov.hk/v1/transport/mtr/bus/getSchedule/';

        // 城巴靜態站點資料
        const CITYBUS_STATIC_STOPS = {
            '50M': [
                { stopId: '001234', name: '新圍苑', lat: 22.4035, lon: 113.9672, dir: 'I', destination: '屯門方向' },
                { stopId: '001235', name: '屯門站', lat: 22.3950, lon: 113.9730, dir: 'O', destination: '市區方向' }
            ]
        };

        // 九巴靜態站點資料
        const KMB_STATIC_STOPS = {
            '960': [
                { stopId: 'KW16-W-1950-0', name: '石排站', lat: 22.4035, lon: 113.9672, dir: 'I', destination: '屯門方向' },
                { stopId: 'KW16-E-2000-0', name: '石排站', lat: 22.4035, lon: 113.9672, dir: 'O', destination: '市區方向' }
            ]
        };

        // 港鐵巴士靜態站點資料
        const MTR_BUS_STATIC_STOPS = {
            'K51': [
                { stopId: 'TUEN MUN STATION', name: '屯門站', lat: 22.395, lon: 113.973, dir: 'I', destination: '屯門方向' },
                { stopId: 'SIU HONG STATION', name: '兆康站', lat: 22.412, lon: 113.979, dir: 'O', destination: '市區方向' }
            ]
        };

        let userLat, userLon;

        async function init() {
            try {
                const position = await getUserLocation();
                userLat = position.coords.latitude;
                userLon = position.coords.longitude;
                document.getElementById('location').innerHTML = `定位座標：(${userLat.toFixed(4)}, ${userLon.toFixed(4)})`;
                await displayNearbyRoutes();
            } catch (error) {
                document.getElementById('location').innerHTML = `定位失敗：${error.message}`;
            }
        }

        async function displayNearbyRoutes() {
            const routesDiv = document.getElementById('routes');
            routesDiv.innerHTML = '正在載入附近路線...';

            try {
                // 城巴
                let citybusStops = await fetchStops(CITYBUS_STOP_API, CITYBUS_STATIC_STOPS, 'citybus');
                let citybusRoutes = await processNearbyRoutes(citybusStops, '城巴');

                // 九巴
                let kmbStops = await fetchStops(KMB_STOP_API, KMB_STATIC_STOPS, 'kmb');
                let kmbRoutes = await processNearbyRoutes(kmbStops, '九巴');

                // 港鐵巴士
                let mtrStops = await fetchStops(MTR_BUS_API, MTR_BUS_STATIC_STOPS, 'mtrbus');
                let mtrRoutes = await processNearbyRoutes(mtrStops, '港鐵巴士');

                const allRoutes = [...citybusRoutes, ...kmbRoutes, ...mtrRoutes];
                if (!allRoutes.length) {
                    routesDiv.innerHTML = '附近無可用巴士路線';
                    return;
                }

                routesDiv.innerHTML = '';
                allRoutes.forEach(route => {
                    const routeItem = document.createElement('div');
                    routeItem.className = 'route-item';
                    routeItem.innerHTML = `${route.stopName}（${route.destination}）：${route.route}`;
                    routeItem.onclick = () => showRouteETA(route.company, route.route, route.stopId, route.stopName, route.destination);
                    routesDiv.appendChild(routeItem);
                });
            } catch (error) {
                routesDiv.innerHTML = `載入路線失敗：${error.message}`;
            }
        }

        async function fetchStops(apiUrl, staticData, company) {
            try {
                const response = await fetch(apiUrl, {
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                if (!response.ok) throw new Error(`API 失敗，狀態碼：${response.status}`);
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.warn(`${company} API 失敗：${error.message}，回退到靜態資料`);
                return staticData[Object.keys(staticData)[0]] || [];
            }
        }

        async function processNearbyRoutes(stops, company) {
            let nearbyRoutes = [];
            stops.forEach(stop => {
                const stopLat = parseFloat(stop.latitude || stop.lat || 0);
                const stopLon = parseFloat(stop.longitude || stop.lon || 0);
                if (isNaN(stopLat) || isNaN(stopLon)) return;

                const distance = calculateDistance(userLat, userLon, stopLat, stopLon);
                if (distance < 2) { // 假設 2 公里範圍
                    const route = stop.route || Object.keys(CITYBUS_STATIC_STOPS)[0] || '未知';
                    nearbyRoutes.push({
                        company: company,
                        route: route,
                        stopId: stop.stop || stop.stopId,
                        stopName: stop.name_tc || stop.name,
                        destination: stop.destination || (stop.dir === 'I' ? '屯門方向' : '市區方向'),
                        distance: distance
                    });
                }
            });
            return nearbyRoutes;
        }

        async function showRouteETA(company, route, stopId, stopName, destination) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '正在獲取到站時間...';

            try {
                let etaData = null;
                if (company === '城巴') {
                    const etaResponse = await fetch(`${CITYBUS_ETA_API}/${stopId}`, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    if (etaResponse.ok) {
                        etaData = await etaResponse.json();
                    }
                } else if (company === '九巴') {
                    const etaResponse = await fetch(`${KMB_STOP_ETA_API}${stopId}`, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    if (etaResponse.ok) {
                        etaData = await etaResponse.json();
                    }
                } else if (company === '港鐵巴士') {
                    const etaResponse = await fetch(`${MTR_BUS_API}${route}`, {
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    if (etaResponse.ok) {
                        etaData = await etaResponse.json();
                    }
                }

                let output = '';
                if (etaData && etaData.data && etaData.data.length) {
                    const etaTimes = etaData.data
                        .filter(eta => eta.route === route && eta.eta)
                        .map(eta => {
                            const etaTime = new Date(eta.eta);
                            const now = new Date();
                            const diff = Math.round((etaTime - now) / 60000);
                            const timeStr = etaTime.toLocaleTimeString('zh-HK', { hour12: false });
                            return `${route} ${stopName}（${eta.destination || destination}）${timeStr} ${diff > 0 ? diff : '即將到達'} 分鐘`;
                        });
                    output = etaTimes.length ? etaTimes.join('<br>') : `${route} ${stopName}：暫無到站時間`;
                } else {
                    output = `${route} ${stopName}：無法即時查詢（示例：5, 10 分鐘）<br>備註：API 查詢失敗，可能是 CORS 或認證問題，建議用後端代理`;
                }
                resultDiv.innerHTML = output;
            } catch (error) {
                resultDiv.innerHTML = `${route} ${stopName}：查詢失敗 - ${error.message}<br>備註：API 查詢失敗，建議用後端代理`;
            }
        }

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('瀏覽器不支持定位功能'));
                } else {
                    navigator.geolocation.getCurrentPosition(resolve, error => {
                        if (error.code === error.PERMISSION_DENIED) {
                            reject(new Error('請允許定位許可以使用此功能'));
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            reject(new Error('無法獲取位置資訊，請檢查網絡或定位設置'));
                        } else if (error.code === error.TIMEOUT) {
                            reject(new Error('定位超時，請稍後再試'));
                        } else {
                            reject(new Error(`定位失敗：${error.message}`));
                        }
                    }, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                }
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
    </script>
</body>
</html>
