<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·´å£«åˆ°ç«™æ™‚é–“æŸ¥è©¢ï¼ˆä¹å·´ & åŸå·´ï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        #loading {
            display: none;
            font-size: 18px;
            color: red;
        }
        .bus-info {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h2>å·´å£«åˆ°ç«™æ™‚é–“æŸ¥è©¢ï¼ˆä¹å·´ & åŸå·´ï¼‰</h2>
    <label for="companySelect">é¸æ“‡å·´å£«å…¬å¸ï¼š</label>
    <select id="companySelect">
        <option value="KMB">ä¹å·´</option>
        <option value="CTB">åŸå·´</option>
    </select>
    <br><br>
    <label for="routeInput">å·´å£«è·¯ç·šï¼š</label>
    <input type="text" id="routeInput" placeholder="ä¾‹å¦‚ 234X">
    <button onclick="searchBus()">æŸ¥è©¢</button>
    <div id="loading">ğŸš æŸ¥è©¢ä¸­...</div>
    <div id="result"></div>

    <script>
        const API_BASE = "https://rt.data.gov.hk/v1/transport/citybus/";
        const KMB_ROUTE_STOP_API = "https://data.etabus.gov.hk/v1/transport/kmb/route-stop";
        const KMB_STOP_API = "https://data.etabus.gov.hk/v1/transport/kmb/stop";
        const KMB_ETA_API = "https://data.etabus.gov.hk/v1/transport/kmb/eta";
        const CTB_ETA_API = API_BASE + "eta/";

        async function fetchData(url) {
            try {
                let response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP éŒ¯èª¤: ${response.status}`);
                let data = await response.json();
                return data;
            } catch (error) {
                console.error("APIè«‹æ±‚éŒ¯èª¤:", error);
                return null;
            }
        }

        function getUserLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½"));
                    return;
                }
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }

        async function searchBus() {
            let route = document.getElementById("routeInput").value.trim().toUpperCase();
            let company = document.getElementById("companySelect").value;

            if (!route) {
                alert("è«‹è¼¸å…¥å·´å£«è·¯ç·š");
                return;
            }

            document.getElementById("loading").style.display = "block";
            document.getElementById("result").innerHTML = "";

            try {
                let userLocation = await getUserLocation();

                if (company === "KMB") {
                    let [routeStops, stopData] = await Promise.all([
                        fetchData(`${KMB_ROUTE_STOP_API}/${route}/inbound/1`),
                        fetchData(KMB_STOP_API)
                    ]);

                    if (!routeStops || !stopData) throw new Error("ç„¡æ³•ç²å–ç«™é»è³‡æ–™");

                    let nearestStop = findNearestStop(userLocation, routeStops, stopData);

                    if (!nearestStop) {
                        document.getElementById("result").innerHTML = "æœªèƒ½æ‰¾åˆ°æœ€è¿‘çš„ä¹å·´ç«™é»ã€‚";
                        return;
                    }

                    let etaData = await fetchData(`${KMB_ETA_API}/KMB/${route}/${nearestStop.stop}`);
                    displayETA(nearestStop, etaData);
                } else if (company === "CTB") {
                    let etaData = await fetchData(`${CTB_ETA_API}${route}`);

                    if (!etaData || !etaData.data.length) {
                        document.getElementById("result").innerHTML = "æœªèƒ½ç²å–åŸå·´å³æ™‚åˆ°ç«™è³‡è¨Šã€‚";
                        return;
                    }

                    displayCTBETA(etaData);
                }
            } catch (error) {
                document.getElementById("result").innerHTML = "æŸ¥è©¢å¤±æ•—ï¼š" + error.message;
                console.error(error);
            } finally {
                document.getElementById("loading").style.display = "none";
            }
        }

        function findNearestStop(userLocation, routeStops, stopData) {
            let userLat = userLocation.coords.latitude;
            let userLng = userLocation.coords.longitude;
            let minDistance = Infinity;
            let nearestStop = null;

            routeStops.data.forEach(stop => {
                let stopInfo = stopData.data.find(s => s.stop === stop.stop);
                if (!stopInfo) return;

                let distance = getDistance(userLat, userLng, stopInfo.lat, stopInfo.long);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStop = stopInfo;
                }
            });

            return nearestStop;
        }

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // åœ°çƒåŠå¾‘ (km)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLng = (lng2 - lng1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * 
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function displayETA(stopInfo, etaData) {
            if (!etaData || !etaData.data.length) {
                document.getElementById("result").innerHTML = `ç«™é»ï¼š${stopInfo.name_tc} - ç„¡å³æ™‚åˆ°ç«™è³‡è¨Šã€‚`;
                return;
            }

            let resultHTML = `<h3>æœ€è¿‘ç«™é»ï¼š${stopInfo.name_tc}</h3>`;
            resultHTML += `<p>åˆ°ç«™æ™‚é–“ï¼š</p><ul>`;
            
            etaData.data.forEach(bus => {
                let arrivalTime = new Date(bus.eta);
                resultHTML += `<li>${arrivalTime.toLocaleTimeString()} (${bus.eta_seq} è™Ÿè»Šï¼‰</li>`;
            });

            resultHTML += `</ul>`;
            document.getElementById("result").innerHTML = resultHTML;
        }

        function displayCTBETA(etaData) {
            let resultHTML = `<h3>åŸå·´ ${etaData.data[0].route} åˆ°ç«™è³‡è¨Š</h3><ul>`;

            etaData.data.forEach(bus => {
                let arrivalTime = new Date(bus.eta);
                resultHTML += `<li>${bus.dest_tc} - ${arrivalTime.toLocaleTimeString()}</li>`;
            });

            resultHTML += `</ul>`;
            document.getElementById("result").innerHTML = resultHTML;
        }
    </script>
</body>
</html>
